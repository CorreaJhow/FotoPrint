@page "/admin"
@inject FotoPrint.Services.ConfigService ConfigSvc
@inject AdminConfigService AdminCfg

@using System.ComponentModel.DataAnnotations

@* =========================================
   LOGIN PROTECTED ADMIN PAGE
   ========================================= *@

@if (!IsLoggedIn)
{
    <div class="max-w-sm mx-auto bg-white rounded-xl shadow-lg p-8 mt-16">
        <h2 class="text-2xl font-bold text-center mb-6">Área Administrativa</h2>
        <input class="block w-full mb-3 px-3 py-2 border rounded-lg"
               @bind="InputUser" placeholder="Usuário" />
        <input class="block w-full mb-3 px-3 py-2 border rounded-lg" type="password"
               @bind="InputPassword" placeholder="Senha" />
        <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-bold"
                @onclick="TryLogin">
            Entrar
        </button>
        @if (!string.IsNullOrWhiteSpace(LoginError))
        {
            <div class="mt-2 text-red-600 text-center">@LoginError</div>
        }
    </div>
}
else
{
    <h2 class="text-2xl font-semibold mb-4">Admin</h2>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="mb-4 p-3 rounded bg-green-50 text-green-800">@Message</div>
    }

    <EditForm Model="cfg" OnValidSubmit="Save">
        <DataAnnotationsValidator />
        <div class="grid md:grid-cols-2 gap-4 max-w-xl">
            <div>
                <label class="block text-sm text-gray-600">Intervalo de impressão (segundos)</label>
                <InputNumber class="w-full border rounded px-3 py-2" @bind-Value="cfg.intervaloImpressaoSegundos" />
            </div>
            <div>
                <label class="block text-sm text-gray-600">Fotos por lote (2 ou 3)</label>
                <InputNumber class="w-full border rounded px-3 py-2" @bind-Value="cfg.fotosPorLote" />
            </div>
        </div>
        <button type="submit" class="mt-4 px-5 py-2 bg-blue-600 text-white rounded-xl">Salvar</button>
    </EditForm>
    <button class="mt-4 px-5 py-2 bg-gray-400 text-white rounded-xl" @onclick="Logout">Sair</button>
}

@code {
    // ========== LOGIN logic ==========
    bool IsLoggedIn = false;
    string InputUser = "", InputPassword = "", LoginError = "";

    void TryLogin()
    {
        var cfgAdmin = AdminCfg.Load();
        if (InputUser == cfgAdmin.AdminUsername && InputPassword == cfgAdmin.AdminPassword)
        {
            IsLoggedIn = true;
            LoginError = "";
        }
        else
        {
            LoginError = "Usuário ou senha inválidos";
        }
    }

    void Logout()
    {
        IsLoggedIn = false;
        InputUser = "";
        InputPassword = "";
        LoginError = "";
    }

    // ========== Admin Panel logic ==========
    FotoPrint.Models.Settings cfg = new();
    string? Message;

    protected override void OnInitialized()
    {
        cfg = ConfigSvc.Load();
    }

    void Save()
    {
        if (cfg.fotosPorLote < 2 || cfg.fotosPorLote > 3) cfg.fotosPorLote = 2;
        if (cfg.intervaloImpressaoSegundos < 5) cfg.intervaloImpressaoSegundos = 5;
        ConfigSvc.Save(cfg);
        Message = "Configurações salvas.";
    }
}
